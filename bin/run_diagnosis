#!/usr/bin/env python3
"""
Convenience script to run the Android Suspend Diagnosis Tool with common options.

This script provides a simple way to run the tool with the most commonly used options.
"""
import argparse
import subprocess
import sys
from pathlib import Path
import os

# Add the src directory to the Python path so we can import the package
script_dir = os.path.dirname(os.path.abspath(__file__))
src_dir = os.path.join(os.path.dirname(script_dir), 'src')
sys.path.insert(0, src_dir)


def parse_args():
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description="Run Android Suspend Diagnosis Tool with common options"
    )
    parser.add_argument(
        "--device", "-d",
        help="Target device serial number (empty for default device)"
    )
    parser.add_argument(
        "--output", "-o",
        default="./reports",
        help="Output directory for reports (default: './reports')"
    )
    parser.add_argument(
        "--ftrace", "-f",
        action="store_true",
        help="Collect ftrace data"
    )
    parser.add_argument(
        "--ai", "-a",
        action="store_true",
        help="Enable AI analysis"
    )
    return parser.parse_args()


def main():
    """Main function."""
    args = parse_args()
    
    # Import the main module from our package
    from suspend_diagnosis.main import main as suspend_main
    from suspend_diagnosis.cli import build_parser
    
    # Build the argument parser and parse the arguments
    parser = build_parser()
    suspend_args = parser.parse_args([])
    
    # Set the arguments based on the command-line options
    if args.device:
        suspend_args.device = args.device
    
    if args.output:
        suspend_args.out = args.output
    
    if args.ftrace:
        suspend_args.collect_ftrace = True
    
    # Run the main function
    print(f"Running suspend diagnosis with device={suspend_args.device}, output={suspend_args.out}")
    suspend_main(suspend_args)
    
    # Find the most recent report
    output_dir = Path(args.output)
    if output_dir.exists():
        report_dirs = sorted(
            [d for d in output_dir.iterdir() if d.is_dir() and d.name.startswith("suspend_diag_")],
            key=lambda d: d.stat().st_mtime,
            reverse=True
        )
        
        if report_dirs:
            latest_report = report_dirs[0]
            html_report = latest_report / "suspend_diagnosis_report.html"
            
            if html_report.exists():
                print(f"\nLatest report: {html_report}")
                print("You can open this HTML file in your browser to view the report.")


if __name__ == "__main__":
    main()
